<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tidal Data Alignment Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.29.3/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 30px;
        }
        
        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .upload-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            border: 2px dashed #cbd5e0;
            transition: all 0.3s;
        }
        
        .upload-card.loaded {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .upload-label {
            display: block;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 10px;
        }
        
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }
        
        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            color: #718096;
        }
        
        .controls-section {
            background: linear-gradient(135deg, #f6f8fb 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .control-group {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .control-label {
            display: block;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .control-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        input[type="number"], input[type="range"] {
            flex: 1;
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
        }
        
        input[type="range"] {
            padding: 0;
        }
        
        .value-display {
            min-width: 80px;
            text-align: center;
            font-weight: bold;
            color: #667eea;
            font-size: 18px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            flex: 1;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .btn-secondary:hover {
            background: #cbd5e0;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .results-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .result-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .result-label {
            color: #718096;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .result-value {
            color: #2d3748;
            font-size: 28px;
            font-weight: bold;
        }
        
        .result-unit {
            color: #a0aec0;
            font-size: 14px;
            margin-left: 4px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 15px;
        }
        
        canvas {
            max-height: 400px;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .status-message.info {
            background: #bee3f8;
            color: #2c5282;
            border: 1px solid #90cdf4;
            display: block;
        }
        
        .status-message.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
            display: block;
        }
        
        .status-message.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
            display: block;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .date-range-selector {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .date-inputs {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        input[type="date"] {
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .correlation-details {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .correlation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .correlation-item {
            text-align: center;
        }
        
        .correlation-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 4px;
        }
        
        .correlation-value {
            font-size: 20px;
            font-weight: bold;
            color: #2d3748;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŒŠ Tidal Data Alignment Tool</h1>
        <p class="subtitle">Upload CSV files and adjust parameters to find optimal alignment</p>
        
        <div id="statusMessage" class="status-message"></div>
        
        <div class="upload-section">
            <div class="upload-card" id="charlestonCard">
                <label class="upload-label">Charleston Bridge Data (charleston_bridge_to_combine.csv)</label>
                <input type="file" id="charlestonFile" accept=".csv">
                <div class="file-info" id="charlestonInfo">No file selected</div>
            </div>
            
            <div class="upload-card" id="palouseCard">
                <label class="upload-label">Palouse Tidegate Data (Palouse_Tide_Data_Combined_newest.csv)</label>
                <input type="file" id="palouseFile" accept=".csv">
                <div class="file-info" id="palouseInfo">No file selected</div>
            </div>
        </div>
        
        <div class="controls-section" id="controlsSection" style="display: none;">
            <h3 style="margin-bottom: 20px; color: #2d3748;">Adjustment Parameters</h3>
            
            <div class="date-range-selector">
                <label class="control-label">Date Range for Analysis</label>
                <div class="date-inputs">
                    <input type="date" id="startDate" value="2022-01-19">
                    <span>to</span>
                    <input type="date" id="endDate" value="2022-06-20">
                    <button class="btn-secondary" onclick="updateDateRange()">Update Range</button>
                </div>
            </div>
            
            <div class="controls-grid">
                <div class="control-group">
                    <label class="control-label">Time Offset (minutes)</label>
                    <div class="control-input-group">
                        <input type="range" id="timeOffsetSlider" min="-180" max="180" value="45" step="15">
                        <input type="number" id="timeOffsetInput" min="-180" max="180" value="45" step="15">
                    </div>
                    <div style="font-size: 12px; color: #718096; margin-top: 5px;">
                        Positive = Charleston lags, Negative = Charleston leads
                    </div>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Vertical Offset (meters)</label>
                    <div class="control-input-group">
                        <input type="range" id="verticalOffsetSlider" min="-2" max="2" value="0.872" step="0.001">
                        <input type="number" id="verticalOffsetInput" min="-2" max="2" value="0.872" step="0.001">
                    </div>
                    <div style="font-size: 12px; color: #718096; margin-top: 5px;">
                        Amount to subtract from Charleston depth
                    </div>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Cross-Correlation Search</label>
                    <div class="button-group">
                        <button class="btn-primary" onclick="findBestCorrelation()">
                            Find Best Lag
                        </button>
                        <button class="btn-secondary" onclick="resetOffsets()">
                            Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="results-section" id="resultsSection" style="display: none;">
            <div class="result-card">
                <div class="result-label">Correlation</div>
                <div class="result-value" id="correlationValue">-</div>
            </div>
            <div class="result-card">
                <div class="result-label">RMSE</div>
                <div class="result-value" id="rmseValue">-<span class="result-unit">m</span></div>
            </div>
            <div class="result-card">
                <div class="result-label">Mean Difference</div>
                <div class="result-value" id="meanDiffValue">-<span class="result-unit">m</span></div>
            </div>
            <div class="result-card">
                <div class="result-label">Data Points</div>
                <div class="result-value" id="dataPointsValue">-</div>
            </div>
        </div>
        
        <div class="chart-container" id="chartSection" style="display: none;">
            <div class="chart-title">Water Level Comparison</div>
            <canvas id="comparisonChart"></canvas>
        </div>
        
        <div class="correlation-details" id="correlationDetails" style="display: none;">
            <h3 style="margin-bottom: 10px; color: #2d3748;">Correlation Analysis</h3>
            <div class="correlation-grid" id="correlationGrid"></div>
        </div>
    </div>
    
    <script>
        // Global variables
        let charlestonData = null;
        let palouseData = null;
        let chart = null;
        let alignedData = null;
        
        // File upload handlers
        document.getElementById('charlestonFile').addEventListener('change', function(e) {
            handleFileUpload(e, 'charleston');
        });
        
        document.getElementById('palouseFile').addEventListener('change', function(e) {
            handleFileUpload(e, 'palouse');
        });
        
        // Slider and input synchronization
        document.getElementById('timeOffsetSlider').addEventListener('input', function(e) {
            document.getElementById('timeOffsetInput').value = e.target.value;
            if (charlestonData && palouseData) {
                calculateAlignment();
            }
        });
        
        document.getElementById('timeOffsetInput').addEventListener('input', function(e) {
            document.getElementById('timeOffsetSlider').value = e.target.value;
            if (charlestonData && palouseData) {
                calculateAlignment();
            }
        });
        
        document.getElementById('verticalOffsetSlider').addEventListener('input', function(e) {
            document.getElementById('verticalOffsetInput').value = e.target.value;
            if (charlestonData && palouseData) {
                calculateAlignment();
            }
        });
        
        document.getElementById('verticalOffsetInput').addEventListener('input', function(e) {
            document.getElementById('verticalOffsetSlider').value = e.target.value;
            if (charlestonData && palouseData) {
                calculateAlignment();
            }
        });
        
        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            showStatus(`Loading ${type} data...`, 'info');
            
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (type === 'charleston') {
                        charlestonData = processCharlestonData(results.data);
                        document.getElementById('charlestonCard').classList.add('loaded');
                        document.getElementById('charlestonInfo').innerHTML = 
                            `Loaded: ${charlestonData.length} valid records<br>` +
                            `Date range: ${charlestonData[0].date.toLocaleDateString()} - ${charlestonData[charlestonData.length-1].date.toLocaleDateString()}`;
                    } else {
                        palouseData = processPalouseData(results.data);
                        document.getElementById('palouseCard').classList.add('loaded');
                        document.getElementById('palouseInfo').innerHTML = 
                            `Loaded: ${palouseData.length} valid records<br>` +
                            `Date range: ${palouseData[0].date.toLocaleDateString()} - ${palouseData[palouseData.length-1].date.toLocaleDateString()}`;
                    }
                    
                    if (charlestonData && palouseData) {
                        document.getElementById('controlsSection').style.display = 'block';
                        showStatus('Both files loaded successfully! Adjust parameters below.', 'success');
                        calculateAlignment();
                    }
                },
                error: function(error) {
                    showStatus(`Error loading ${type} file: ${error.message}`, 'error');
                }
            });
        }
        
        function processCharlestonData(data) {
            return data
                .filter(row => row['DateTime'] && row['Depth m'] !== null && !isNaN(row['Depth m']))
                .map(row => ({
                    date: new Date(row['DateTime']),
                    depth: parseFloat(row['Depth m']),
                    dateString: row['DateTime']
                }))
                .sort((a, b) => a.date - b.date);
        }
        
        function processPalouseData(data) {
            return data
                .filter(row => row['DateTime'] && row['Tidal Level Outside Tidegate [m]'] !== null && !isNaN(row['Tidal Level Outside Tidegate [m]']))
                .map(row => ({
                    date: new Date(row['DateTime']),
                    level: parseFloat(row['Tidal Level Outside Tidegate [m]']),
                    dateString: row['DateTime']
                }))
                .sort((a, b) => a.date - b.date);
        }
        
        function calculateAlignment() {
            const timeOffset = parseInt(document.getElementById('timeOffsetInput').value);
            const verticalOffset = parseFloat(document.getElementById('verticalOffsetInput').value);
            
            // Get date range
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            // Filter data to date range
            const charlestonFiltered = charlestonData.filter(d => d.date >= startDate && d.date <= endDate);
            const palouseFiltered = palouseData.filter(d => d.date >= startDate && d.date <= endDate);
            
            // Create map for quick lookup
            const palouseMap = {};
            palouseFiltered.forEach(row => {
                const key = row.date.toISOString();
                palouseMap[key] = row.level;
            });
            
            // Align data
            alignedData = [];
            charlestonFiltered.forEach(row => {
                // Apply time offset to Charleston
                const adjustedTime = new Date(row.date.getTime() + timeOffset * 60 * 1000);
                const key = row.date.toISOString();
                
                if (palouseMap[key] !== undefined) {
                    alignedData.push({
                        date: row.date,
                        charlestonOriginal: row.depth,
                        charlestonCorrected: row.depth - verticalOffset,
                        palouse: palouseMap[key]
                    });
                }
            });
            
            if (alignedData.length === 0) {
                showStatus('No matching timestamps found in selected date range', 'error');
                return;
            }
            
            // Calculate statistics
            const correlation = calculateCorrelation(
                alignedData.map(d => d.charlestonCorrected),
                alignedData.map(d => d.palouse)
            );
            
            const rmse = calculateRMSE(
                alignedData.map(d => d.charlestonCorrected),
                alignedData.map(d => d.palouse)
            );
            
            const meanDiff = calculateMeanDifference(
                alignedData.map(d => d.charlestonCorrected),
                alignedData.map(d => d.palouse)
            );
            
            // Update display
            document.getElementById('correlationValue').textContent = correlation.toFixed(4);
            document.getElementById('rmseValue').innerHTML = rmse.toFixed(3) + '<span class="result-unit">m</span>';
            document.getElementById('meanDiffValue').innerHTML = meanDiff.toFixed(3) + '<span class="result-unit">m</span>';
            document.getElementById('dataPointsValue').textContent = alignedData.length.toLocaleString();
            
            document.getElementById('resultsSection').style.display = 'grid';
            
            // Update chart
            updateChart();
        }
        
        function calculateCorrelation(x, y) {
            const n = x.length;
            const meanX = x.reduce((a, b) => a + b, 0) / n;
            const meanY = y.reduce((a, b) => a + b, 0) / n;
            
            let sumXY = 0, sumX2 = 0, sumY2 = 0;
            for (let i = 0; i < n; i++) {
                const dx = x[i] - meanX;
                const dy = y[i] - meanY;
                sumXY += dx * dy;
                sumX2 += dx * dx;
                sumY2 += dy * dy;
            }
            
            return sumXY / Math.sqrt(sumX2 * sumY2);
        }
        
        function calculateRMSE(x, y) {
            const n = x.length;
            let sumSqDiff = 0;
            for (let i = 0; i < n; i++) {
                const diff = x[i] - y[i];
                sumSqDiff += diff * diff;
            }
            return Math.sqrt(sumSqDiff / n);
        }
        
        function calculateMeanDifference(x, y) {
            const n = x.length;
            let sumDiff = 0;
            for (let i = 0; i < n; i++) {
                sumDiff += Math.abs(x[i] - y[i]);
            }
            return sumDiff / n;
        }
        
        function updateChart() {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            
            // Sample data for visualization (every 10th point for performance)
            const sampleRate = Math.max(1, Math.floor(alignedData.length / 500));
            const sampledData = alignedData.filter((_, i) => i % sampleRate === 0);
            
            const chartData = {
                labels: sampledData.map(d => d.date.toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit' 
                })),
                datasets: [{
                    label: 'Charleston Original',
                    data: sampledData.map(d => d.charlestonOriginal),
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.4
                }, {
                    label: 'Charleston Corrected',
                    data: sampledData.map(d => d.charlestonCorrected),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    borderDash: [5, 5],
                    tension: 0.4
                }, {
                    label: 'Palouse',
                    data: sampledData.map(d => d.palouse),
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.4
                }]
            };
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Date/Time'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Water Level (m)'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
            
            document.getElementById('chartSection').style.display = 'block';
        }
        
        function findBestCorrelation() {
            if (!charlestonData || !palouseData) return;
            
            showStatus('Searching for optimal time lag...', 'info');
            document.getElementById('correlationDetails').style.display = 'block';
            
            const verticalOffset = parseFloat(document.getElementById('verticalOffsetInput').value);
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            // Test different time lags
            const lags = [];
            for (let lag = -180; lag <= 180; lag += 15) {
                // Filter data
                const charlestonFiltered = charlestonData.filter(d => d.date >= startDate && d.date <= endDate);
                const palouseFiltered = palouseData.filter(d => d.date >= startDate && d.date <= endDate);
                
                // Create map
                const palouseMap = {};
                palouseFiltered.forEach(row => {
                    const key = row.date.toISOString();
                    palouseMap[key] = row.level;
                });
                
                // Align with lag
                const aligned = [];
                charlestonFiltered.forEach(row => {
                    const adjustedTime = new Date(row.date.getTime() + lag * 60 * 1000);
                    const key = row.date.toISOString();
                    
                    if (palouseMap[key] !== undefined) {
                        aligned.push({
                            charleston: row.depth - verticalOffset,
                            palouse: palouseMap[key]
                        });
                    }
                });
                
                if (aligned.length > 0) {
                    const correlation = calculateCorrelation(
                        aligned.map(d => d.charleston),
                        aligned.map(d => d.palouse)
                    );
                    
                    lags.push({
                        lag: lag,
                        correlation: correlation,
                        points: aligned.length
                    });
                }
            }
            
            // Find best lag
            const bestLag = lags.reduce((best, current) => 
                current.correlation > best.correlation ? current : best
            );
            
            // Update controls with best lag
            document.getElementById('timeOffsetSlider').value = bestLag.lag;
            document.getElementById('timeOffsetInput').value = bestLag.lag;
            
            // Show top correlations
            const topLags = lags.sort((a, b) => b.correlation - a.correlation).slice(0, 5);
            const gridHtml = topLags.map((lag, i) => `
                <div class="correlation-item">
                    <div class="correlation-label">${lag.lag > 0 ? 'Lag' : 'Lead'} ${Math.abs(lag.lag)} min</div>
                    <div class="correlation-value" style="color: ${i === 0 ? '#48bb78' : '#718096'}">${lag.correlation.toFixed(4)}</div>
                </div>
            `).join('');
            
            document.getElementById('correlationGrid').innerHTML = gridHtml;
            
            showStatus(`Best correlation found: ${bestLag.correlation.toFixed(4)} at ${bestLag.lag} minutes lag`, 'success');
            
            // Recalculate with best lag
            calculateAlignment();
        }
        
        function resetOffsets() {
            document.getElementById('timeOffsetSlider').value = 0;
            document.getElementById('timeOffsetInput').value = 0;
            document.getElementById('verticalOffsetSlider').value = 0;
            document.getElementById('verticalOffsetInput').value = 0;
            
            if (charlestonData && palouseData) {
                calculateAlignment();
            }
        }
        
        function updateDateRange() {
            if (charlestonData && palouseData) {
                calculateAlignment();
            }
        }
        
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusEl.className = 'status-message';
                }, 5000);
            }
        }
    </script>
</body>
</html>